<html>

<head>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript" language="javascript"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/smoothie/1.34.0/smoothie.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.js"></script>
  <style type="text/css">
    #canv {
      border-style: solid;

    }

    #resLoad {
      /*border-style: solid;*/
      float: left;
      width: 350px;
      height: 135px;
    }

    #userPerCpu {
      /*border-style: solid;*/
      width: 350px;
      height: 135px;
      float: left;
    }

    #palleteTable {
      float: left;
      height: 121px;
    }

    #panel {
      width: 1000px;

    }

    .colorBtn {
      width: 35px;
      height: 25px;
    }
  </style>

</head>

<body>
    <canvas id="canv" width="1880" height="700"></canvas>
  <div>
    <div style="float:left">Пользователей онлайн: </div>
    <div id="userOnline">0</div>
    <div style="float:left">Вам осталось ждать: </div>
    <div id="timeLeft">0</div>
  </div>

  <script>
    //img

    var imageBot = [
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#fcb800","#000000","#000000","#000000","#000000","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#fcd884","#000000","#000000","#000000","#000000","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#fcd884","#fcd884","#000000","#000000","#000000","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#fcd884","#dcf878","#fcb800","#000000","#000000","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#fcd884","#fcd884","#fcd884","#000000","#000000","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#fca048","#fcb800","#dc00d4","#fca048","#000000","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#94008c","#dc00d4","#000000","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#dc00d4","#000000","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#94008c","#dc00d4","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#94008c","#dc00d4","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#94008c","#dc00d4","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#94008c","#dc00d4","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#94008c","#dc00d4","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#fcb800","#94008c","#94008c","#000000","#000000","#000000","#000000","#000000","#000000","#94008c","#dc00d4","#fca048",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#fcb800","#dc00d4","#dc00d4","#dc00d4","#94008c","#000000","#000000","#000000","#000000","#94008c","#dc00d4","#dc00d4","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#dc00d4","#dc00d4","#94008c","#000000","#000000","#000000","#94008c","#dc00d4","#dc00d4","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#fcb800","#000000","#000000","#000000","#94008c","#dc00d4","#94008c","#94008c","#94008c","#94008c","#94008c","#dc00d4","#dc00d4","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#94008c","#94008c","#000000","#000000","#000000","#94008c","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#94008c","#94008c","#dc00d4","#000000","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#94008c","#94008c","#94008c","#fcd884","#fcd884","#fcd884","#dc00d4","#dc00d4","#fc78fc","#fc78fc","#dc00d4","#94008c","#dc00d4","#fca048","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#94008c","#dc00d4","#94008c","#000000","#000000","#000000","#000000","#000000","#94008c","#dc00d4","#94008c","#dc00d4","#dc00d4","#94008c","#94008c","#fcb800","#dc00d4","#dc00d4","#fc78fc","#fc78fc","#fc78fc","#dc00d4","#94008c","#dcf878","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#000000","#dc00d4","#dc00d4","#94008c","#000000","#000000","#000000","#fcb800","#94008c","#94008c","#94008c","#94008c","#dc00d4","#dc00d4","#dc00d4","#94008c","#94008c","#dc00d4","#dc00d4","#fc78fc","#dc00d4","#dc00d4","#000000","#fca048","#000000",],
      ["#000000","#000000","#000000","#000000","#94008c","#94008c","#c8c0c0","#dc00d4","#94008c","#000000","#000000","#000000","#000000","#000000","#fcb800","#dcf878","#94008c","#dc00d4","#fc78fc","#fc78fc","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#000000","#fcd884","#000000",],
      ["#000000","#000000","#000000","#94008c","#dc00d4","#c8c0c0","#ffffff","#dc00d4","#94008c","#94008c","#000000","#000000","#000000","#000000","#dc00d4","#dcf878","#dc00d4","#fc78fc","#fc78fc","#fc78fc","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#fc78fc","#fc7858","#fc7858","#fcd884","#000000",],
      ["#000000","#fcb800","#fcb800","#dc00d4","#dc00d4","#94008c","#94008c","#dc00d4","#94008c","#94008c","#94008c","#94008c","#94008c","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#fc78fc","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#fc7858","#fc7858","#fc7858","#fcb800","#000000",],
      ["#fcd884","#fc7858","#94008c","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#94008c","#dc00d4","#94008c","#94008c","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#94008c","#fca048","#fca048","#fc7858","#fc7858","#fc7858","#fcd884","#000000","#000000",],
      ["#fcd884","#fca048","#94008c","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#94008c","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#94008c","#fcb800","#fcb800","#fca048","#fc7858","#fca048","#fc7858","#fc7858","#fc7858","#fc7858","#fcb800","#000000","#000000",],
      ["#000000","#000000","#94008c","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#dc00d4","#94008c","#94008c","#fcb800","#fca048","#000000","#94008c","#000000","#000000","#000000","#fcb800","#fca048","#fcd884","#fc7858","#fc7858","#fc7858","#fc7858","#fc7858","#fcd884","#000000","#000000","#000000",],
      ["#000000","#fcd884","#fca048","#94008c","#fca048","#94008c","#dc00d4","#dc00d4","#dc00d4","#94008c","#fca048","#fc7858","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#fcb800","#fcb800","#fcb800","#fc7858","#fc7858","#fc7858","#fca048","#fcb800","#000000","#000000","#000000",],
      ["#000000","#fcd884","#fca048","#fcd884","#fcd884","#fcd884","#fcb800","#94008c","#94008c","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#fcd884","#fcb800","#fcb800","#fcd884","#fcb800","#000000","#000000","#000000","#000000",],
      ["#000000","#fcd884","#000000","#fcb800","#fcd884","#dcf878","#fcb800","#fcd884","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#fcb800","#fcd884","#000000","#000000","#000000","#000000","#000000","#000000",],
      ["#000000","#000000","#000000","#fcd884","#fcd884","#fcb800","#fc7858","#fca048","#fcb800","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000",],
      ["#000000","#000000","#000000","#fcd884","#fcd884","#fcd884","#fca048","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000",],
      ["#000000","#000000","#000000","#fcb800","#fcd884","#dcf878","#fcb800","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000",],
      ["#000000","#000000","#000000","#000000","#dcf878","#dcf878","#fcd884","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#fcd884","#fca048","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000",],
      ["#000000","#000000","#000000","#000000","#000000","#fcd884","#fca048","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000",],
      ["#000000","#000000","#000000","#000000","#fcd884","#fcb800","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000",]]



    //create pallete
    //1200 500
    var currentColor = "#000000";
    var pixelSize = 5;
    var localPixelSize = pixelSize + 1; //pixelSizeWidthBorder
    var backgroundColor = "#f5f5dc";
    var resLoadGrapfIsStart = false;
    var pallete = ["#788084", "#0000fc", "#0000c4", "#4028c4", "#94008c", "#ac0028", "#ac1000", "#8c1800", "#503000", "#007800", "#006800", "#005800", "#004058", "#000000",
      "#bcc0c4", "#0078fc", "#0088fc", "#6848fc", "#dc00d4", "#e40060", "#fc3800", "#e46018", "#ac8000", "#00b800", "#00a800", "#00a848", "#008894", "#2c2c2c",
      "#fcf8fc", "#38c0fc", "#6888fc", "#9c78fc", "#fc78fc", "#fc589c", "#fc7858", "#fca048", "#fcb800", "#bcf818", "#58d858", "#58f89c", "#00e8e4", "#606060",
      "#ffffff", "#a4e8fc", "#bcb8fc", "#dcb8fc", "#fcb8fc", "#d4c0e0", "#f4d0b4", "#fce0b4", "#fcd884", "#dcf878", "#b8f878", "#b0f0d8", "#00f8fc", "#c8c0c0"
    ];
    var palleteBtn = new Array(pallete.length);
    var palleteFnc = new Array(pallete.length); //todo: refactor it
    document.write("<div id='panel'><table id='palleteTable' border='1'>");
    var trOpen = false;
    for (var i = 0; i < pallete.length; ++i) {
      if (i > 0 && i % 14 == 0) {
        if (trOpen == false) {
          trOpen = true;
          document.write("<tr>");
        } else {
          document.write("</tr>");
        }
      }

      document.write("<td id=" + pallete[i] + " class='colorBtn' name='" + pallete[i] + "' style='background:" + pallete[i] + "' > </td>");


      palleteBtn[i] = document.getElementById(pallete[i]);
      palleteFnc[i] = function() {
        console.log(
          currentColor = this.getAttribute("name"));

      };

    }

    for (var i = 0; i < palleteBtn.length; ++i) {
      palleteBtn[i].onclick = palleteFnc[i];


    }
    document.write("</table>");

    document.write(" <canvas id='resLoad'  width ='350' </canvas> </div> ");
    document.write("<div id='userPerCpu'  ></div>")
    //  document.write("<canvas id='userPerCpu' width='300' height=" + $('#palleteTable').height() + "</canvas>  ");
    //work with canvas
    var canvas = document.getElementById('canv');
    var ctx = canvas.getContext('2d');

    var canvasWidth = canvas.width;
    var canvasHeight = canvas.height;

    ctx.fillStyle = "#f5f5dc";
    ctx.fillRect(0, 0, canvasWidth, canvasHeight);
    //draw cells
    ctx.strokeStyle = "#989898";
    ctx.lineWidth = 1;
    for (var i = -0.5; i < canvasWidth; i += localPixelSize) {
      //for (var j = 0; j < 500; j++) {
      ctx.beginPath();
      ctx.moveTo(i, 0);
      ctx.lineTo(i, canvasHeight);
      ctx.stroke();
      //  }

    }
    for (var i = -0.5; i < canvasHeight; i += localPixelSize) {
      //for (var j = 0; j < 500; j++) {
      ctx.beginPath();
      ctx.moveTo(0, i);
      ctx.lineTo(canvasWidth, i);
      ctx.stroke();
      //  }

    }
    var drawPixel = function(x, y, color) {
      ctx.fillStyle = color;
      ctx.fillRect(x, y, pixelSize, pixelSize);
    }

    //client

    var socket = io();
    var canvasMap1;
    socket.on('send canvas map', function(msg) {
      //  console.log(msg);
      canvasMap1 = msg;
      for (var i = 0; i < msg.length; ++i) {
        for (var j = 0; j < msg[i].length; ++j) {
          if (msg[i][j] != backgroundColor) {
            var pos = getPosByCell(i, j);
            drawPixel(pos.x, pos.y, msg[i][j]);
          }
        }
      }
    });

    var userPerCpuPlot = document.getElementById('userPerCpu');

    //work with Status
    var uptimeField = document.getElementById('uptime');
    var userOnlineField = document.getElementById('userOnline');
    var timeLeftField = document.getElementById('timeLeft');
    socket.on('query update status', function(jsonData) {
      socket.emit('query status data');
    });
    var cpuLoadSeries = new TimeSeries();
    var userPerCpu = new Map();
    socket.on('update status', function(jsonData) {
      if (!resLoadGrapfIsStart) {
        createCpuTimeline();

        resLoadGrapfIsStart = true;
      }
      var data = JSON.parse(jsonData);
      userOnline.innerHTML = data.userOnline;
      timeLeft.innerHTML = data.timeLeft + " сек";
      cpuLoadSeries.append(new Date().getTime(), data.cpuLoad);
      userPerCpu.set(data.userOnline, data.cpuLoad);

      updateUserPerCpuPlot();
    });

    var updateUserPerCpuPlot = function() {
      $(function() {
        var d1 = [];
        for (var [key, value] of userPerCpu.entries()) {
          d1.push([key, value]);
        }
        $.plot("#userPerCpu", [{
          data: d1,
          bars: {
            show: true,
            barWidth: 0.9,
            align: "center"
          }
        }]);
      });
    };

    function createCpuTimeline() {
      var chart = new SmoothieChart({
        maxValue: 100,
        minValue: 0
      });
      chart.addTimeSeries(cpuLoadSeries, {
        strokeStyle: 'rgba(0, 255, 0, 1)',
        fillStyle: 'rgba(0, 255, 0, 0.2)',
        lineWidth: 1
      });
      chart.streamTo(document.getElementById("resLoad"), 1000);
    }

    socket.on('new point', function(msg) {
      var data = JSON.parse(msg);
      var coordCell = getPosByCell(data.Xpos, data.Ypos);
      drawPixel(coordCell.x, coordCell.y, data.Color);
    });

    function getCursorPosition(canvas, curX, curY) {
      canvas = canvas || window.event

      var point = new Object(),
        x = 0,
        y = 0;

      var rect = canvas.getBoundingClientRect();
      var scaleX = canvas.width / rect.width;
      var scaleY = canvas.height / rect.height;

      point.x = Math.ceil((curX - rect.left) * scaleX);
      point.y = Math.ceil((curY - rect.top) * scaleY);


      // point.x = curX - canvas.offsetLeft -2 ;
      // point.y = curY - canvas.offsetTop  -2;
      return point;
    }

    //main
    var getPosByCell = function(inpXcell, inpYcell) {
      var point = new Object(),
        x = 0,
        y = 0;
      point.x = inpXcell * (localPixelSize);
      point.y = inpYcell * (localPixelSize);
      if (point.x < 0) point.x = 0;
      if (point.y < 0) point.y = 0;
      return point;
    }

    var getCellByPos = function(inpX, inpY) {
      var point = new Object(),
        x = 0,
        y = 0;
      point.x = Math.floor((inpX) / (localPixelSize));
      point.y = Math.floor((inpY) / (localPixelSize));
      return point;
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }


    $(canvas).click(async function(e) {
      var coord = getCursorPosition(canvas, e.clientX, e.clientY);
      console.log("User тыкнул:" + coord.x + " " + coord.y);
      var coordCell = getCellByPos(coord.x, coord.y);
      console.log("Координаты ячейки:" + coordCell.x + " " + coordCell.y);
      var newCoord = getPosByCell(coordCell.x, coordCell.y);
      console.log("User получил:" + newCoord.x + " " + newCoord.y);

      //drawPixel(newCoord.x, newCoord.y, currentColor);
      for (var y = 0; y < imageBot[0].length; ++y) {

        for (var x = 0; x < imageBot.length; ++x) {
          if (imageBot[x][y] != "#000000"  ){
            //    console.log(imageBot[x][y]+" "+canvasMap1[coordCell.x+x-1][coordCell.y+y]);
            //await  sleep (Math.random() * 800 + 100);
            currentColor = imageBot[x][y];
          } else {
            continue;
          }

          socket.emit('on paint', JSON.stringify({
            Xpos: coordCell.x + x,
            Ypos: coordCell.y + y,
            Color: currentColor
          }));
        }
      }
      if (timeLeftField.innerHTML == "0 сек") {
        timeLeftField.innerHTML = ">1сек";
      }


    });
  </script>

</body>

</html>
